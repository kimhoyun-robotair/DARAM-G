<?xml version="1.0"?>
<robot name="robotarm" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- 매크로 파라미터:
       parent : 로버 쪽에 붙일 부모 링크 이름
       prefix : 조인트/링크 이름 접두사 (충돌 방지)
       xyz/rpy: 부모 대비 장착 위치/자세
       add_ros2_control : true면 ros2_control + gz 플러그인까지 포함
  -->
  <xacro:macro name="robotarm" params="
      parent:=base_footprint
      prefix:=arm_
      xyz:='0 0 0'
      rpy:='0 0 0'
      add_ros2_control:=true">

    <xacro:property name="P" value="${prefix}"/>

    <!-- ========== 장착용 fixed 조인트 (로버에 붙임) ========== -->
    <joint name="${P}mount" type="fixed">
      <parent link="${parent}"/>
      <child link="${P}base_link"/>
      <origin xyz="${xyz}" rpy="${rpy}"/>
    </joint>

    <!-- ===== 재질 ===== -->
    <material name="${P}gray"><color rgba="0.6 0.6 0.6 1.0"/></material>
    <material name="${P}blue"><color rgba="0.2 0.4 0.8 1.0"/></material>
    <material name="${P}black"><color rgba="0.1 0.1 0.1 1.0"/></material>

    <!-- ===== 베이스 ===== -->
    <link name="${P}base_link">
      <visual>
        <geometry><cylinder radius="0.06" length="0.04"/></geometry>
        <material name="${P}black"/>
        <origin xyz="0 0 0.02" rpy="0 0 0"/>
      </visual>
      <collision>
        <geometry><cylinder radius="0.06" length="0.04"/></geometry>
        <origin xyz="0 0 0.02" rpy="0 0 0"/>
      </collision>
      <inertial>
        <mass value="1.0"/>
        <origin xyz="0 0 0.02" rpy="0 0 0"/>
        <inertia ixx="0.001" iyy="0.001" izz="0.001" ixy="0" ixz="0" iyz="0"/>
      </inertial>
    </link>

    <!-- 1: base_yaw (Z) -->
    <joint name="${P}base_yaw" type="revolute">
      <parent link="${P}base_link"/>
      <child link="${P}link1"/>
      <origin xyz="0 0 0.04" rpy="0 0 0"/>
      <axis xyz="0 0 1"/>
      <limit effort="5" velocity="2.0" lower="-3.1416" upper="3.1416"/>
      <dynamics damping="0.1" friction="0.0"/>
    </joint>

    <link name="${P}link1">
      <visual>
        <geometry><box size="0.06 0.06 0.10"/></geometry>
        <origin xyz="0 0 0.05" rpy="0 0 0"/>
        <material name="${P}gray"/>
      </visual>
      <collision>
        <geometry><box size="0.06 0.06 0.10"/></geometry>
        <origin xyz="0 0 0.05" rpy="0 0 0"/>
      </collision>
      <inertial>
        <mass value="0.4"/>
        <origin xyz="0 0 0.05" rpy="0 0 0"/>
        <inertia ixx="0.0003" iyy="0.0003" izz="0.0001" ixy="0" ixz="0" iyz="0"/>
      </inertial>
    </link>

    <!-- 2: shoulder_pitch (Y) -->
    <joint name="${P}shoulder_pitch" type="revolute">
      <parent link="${P}link1"/>
      <child link="${P}link2"/>
      <origin xyz="0 0 0.10" rpy="0 0 0"/>
      <axis xyz="0 1 0"/>
      <limit effort="5" velocity="2.0" lower="-2.6" upper="2.6"/>
      <dynamics damping="0.1" friction="0.0"/>
    </joint>

    <link name="${P}link2">
      <visual>
        <geometry><box size="0.20 0.04 0.04"/></geometry>
        <origin xyz="0.10 0 0" rpy="0 0 0"/>
        <material name="${P}blue"/>
      </visual>
      <collision>
        <geometry><box size="0.20 0.04 0.04"/></geometry>
        <origin xyz="0.10 0 0" rpy="0 0 0"/>
      </collision>
      <inertial>
        <mass value="0.35"/>
        <origin xyz="0.10 0 0" rpy="0 0 0"/>
        <inertia ixx="0.0002" iyy="0.0005" izz="0.0005" ixy="0" ixz="0" iyz="0"/>
      </inertial>
    </link>

    <!-- 3: elbow_pitch (Y) -->
    <joint name="${P}elbow_pitch" type="revolute">
      <parent link="${P}link2"/>
      <child link="${P}link3"/>
      <origin xyz="0.20 0 0" rpy="0 0 0"/>
      <axis xyz="0 1 0"/>
      <limit effort="5" velocity="2.0" lower="-2.6" upper="2.6"/>
      <dynamics damping="0.1" friction="0.0"/>
    </joint>

    <link name="${P}link3">
      <visual>
        <geometry><box size="0.18 0.035 0.035"/></geometry>
        <origin xyz="0.09 0 0" rpy="0 0 0"/>
        <material name="${P}blue"/>
      </visual>
      <collision>
        <geometry><box size="0.18 0.035 0.035"/></geometry>
        <origin xyz="0.09 0 0" rpy="0 0 0"/>
      </collision>
      <inertial>
        <mass value="0.30"/>
        <origin xyz="0.09 0 0" rpy="0 0 0"/>
        <inertia ixx="0.00015" iyy="0.0004" izz="0.0004" ixy="0" ixz="0" iyz="0"/>
      </inertial>
    </link>

    <!-- 4: wrist_pitch (Y) -->
    <joint name="${P}wrist_pitch" type="revolute">
      <parent link="${P}link3"/>
      <child link="${P}wrist_link"/>
      <origin xyz="0.18 0 0" rpy="0 0 0"/>
      <axis xyz="0 1 0"/>
      <limit effort="3" velocity="2.5" lower="-2.6" upper="2.6"/>
      <dynamics damping="0.05" friction="0.0"/>
    </joint>

    <link name="${P}wrist_link">
      <visual>
        <geometry><box size="0.08 0.03 0.03"/></geometry>
        <origin xyz="0.04 0 0" rpy="0 0 0"/>
        <material name="${P}gray"/>
      </visual>
      <collision>
        <geometry><box size="0.08 0.03 0.03"/></geometry>
        <origin xyz="0.04 0 0" rpy="0 0 0"/>
      </collision>
      <inertial>
        <mass value="0.2"/>
        <origin xyz="0.04 0 0" rpy="0 0 0"/>
        <inertia ixx="0.00008" iyy="0.0001" izz="0.0001" ixy="0" ixz="0" iyz="0"/>
      </inertial>
    </link>

    <!-- 그리퍼 (좌/우 핑거, 우측은 mimic) -->
    <joint name="${P}gripper_mount" type="fixed">
      <parent link="${P}wrist_link"/>
      <child link="${P}gripper_palm"/>
      <origin xyz="0.08 0 0" rpy="0 0 0"/>
    </joint>

    <link name="${P}gripper_palm">
      <visual>
        <geometry><box size="0.06 0.04 0.02"/></geometry>
        <origin xyz="0.03 0 0" rpy="0 0 0"/>
        <material name="${P}black"/>
      </visual>
      <collision>
        <geometry><box size="0.06 0.04 0.02"/></geometry>
        <origin xyz="0.03 0 0" rpy="0 0 0"/>
      </collision>
      <inertial>
        <mass value="0.1"/>
        <origin xyz="0.03 0 0" rpy="0 0 0"/>
        <inertia ixx="0.00003" iyy="0.00004" izz="0.00004" ixy="0" ixz="0" iyz="0"/>
      </inertial>
    </link>

    <joint name="${P}left_finger_joint" type="prismatic">
      <parent link="${P}gripper_palm"/>
      <child link="${P}left_finger"/>
      <origin xyz="0.03 0.01 0" rpy="0 0 0"/>
      <axis xyz="0 1 0"/>
      <limit effort="50" velocity="0.1" lower="0.0" upper="0.02"/>
      <dynamics damping="0.0" friction="0.0"/>
    </joint>

    <link name="${P}left_finger">
      <visual>
        <geometry><box size="0.04 0.01 0.02"/></geometry>
        <origin xyz="0.02 0 0" rpy="0 0 0"/>
        <material name="${P}gray"/>
      </visual>
      <collision>
        <geometry><box size="0.04 0.01 0.02"/></geometry>
        <origin xyz="0.02 0 0" rpy="0 0 0"/>
      </collision>
      <inertial>
        <mass value="0.02"/>
        <origin xyz="0.02 0 0" rpy="0 0 0"/>
        <inertia ixx="1e-5" iyy="1e-5" izz="1e-5" ixy="0" ixz="0" iyz="0"/>
      </inertial>
    </link>

    <joint name="${P}right_finger_joint" type="prismatic">
      <parent link="${P}gripper_palm"/>
      <child link="${P}right_finger"/>
      <origin xyz="0.03 -0.01 0" rpy="0 0 0"/>
      <axis xyz="0 -1 0"/>
      <limit effort="50" velocity="0.1" lower="0.0" upper="0.02"/>
      <mimic joint="${P}left_finger_joint" multiplier="1.0" offset="0.0"/>
    </joint>

    <link name="${P}right_finger">
      <visual>
        <geometry><box size="0.04 0.01 0.02"/></geometry>
        <origin xyz="0.02 0 0" rpy="0 0 0"/>
        <material name="${P}gray"/>
      </visual>
      <collision>
        <geometry><box size="0.04 0.01 0.02"/></geometry>
        <origin xyz="0.02 0 0" rpy="0 0 0"/>
      </collision>
      <inertial>
        <mass value="0.02"/>
        <origin xyz="0.02 0 0" rpy="0 0 0"/>
        <inertia ixx="1e-5" iyy="1e-5" izz="1e-5" ixy="0" ixz="0" iyz="0"/>
      </inertial>
    </link>

    <!-- 툴 프레임 -->
    <joint name="${P}tool0_fixed" type="fixed">
      <parent link="${P}gripper_palm"/>
      <child link="${P}tool0"/>
      <origin xyz="0.06 0 0" rpy="0 0 0"/>
    </joint>
    <link name="${P}tool0"/>

    <!-- ===== (옵션) ros2_control + gz 플러그인 ===== -->
    <xacro:if value="${add_ros2_control}">
      <ros2_control name="gz_system" type="system">
        <hardware>
          <plugin>gz_ros2_control/GazeboSimSystem</plugin>
        </hardware>
        <joint name="${P}base_yaw">
          <command_interface name="position"/>
          <state_interface name="position"/>
          <state_interface name="velocity"/>
        </joint>
        <joint name="${P}shoulder_pitch">
          <command_interface name="position"/>
          <state_interface name="position"/>
          <state_interface name="velocity"/>
        </joint>
        <joint name="${P}elbow_pitch">
          <command_interface name="position"/>
          <state_interface name="position"/>
          <state_interface name="velocity"/>
        </joint>
        <joint name="${P}wrist_pitch">
          <command_interface name="position"/>
          <state_interface name="position"/>
          <state_interface name="velocity"/>
        </joint>
        <joint name="${P}left_finger_joint">
          <command_interface name="position"/>
          <state_interface name="position"/>
          <state_interface name="velocity"/>
        </joint>
      </ros2_control>

      <!-- GZ 플러그인 (로봇 전체에 1회만 포함해야 함) -->
      <gazebo>
        <plugin filename="libign_ros2_control-system.so"
                name="ign_ros2_control::IgnitionROS2ControlPlugin">
          <!-- 선택: 컨트롤러 설정 yaml 경로를 바로 넘길 수도 있음 -->
          <parameters>$(find daramg_sim)/config/controllers.yaml</parameters>
          <ros2_control>
            <parameters>
              <position_proportional_gain>6.0</position_proportional_gain>
            </parameters>
          </ros2_control>
        </plugin>
      </gazebo>
    </xacro:if>

  </xacro:macro>
</robot>
